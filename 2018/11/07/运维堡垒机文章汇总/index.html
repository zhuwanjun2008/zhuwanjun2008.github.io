<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="记录技术路上的点滴"><title>运维堡垒机文章汇总 | 万骏的博客</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.3"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/normalize/8.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">运维堡垒机文章汇总</h1><a id="logo" href="/.">万骏的博客</a><p class="description">记录技术路上的点滴</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">运维堡垒机文章汇总</h1><div class="post-meta">Nov 7, 2018<script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span><span class="post-time"><span class="post-meta-item-text"> | </span><span class="post-meta-item-icon"><i class="fa fa-keyboard-o"></i><span class="post-count"> 1.6k</span><span class="post-meta-item-text"> 字</span></span></span><span class="post-time"> | <span class="post-meta-item-icon"><i class="fa fa-hourglass-half"></i><span class="post-count"> 5</span><span class="post-meta-item-text"> 分钟</span></span></span></div><div class="post-content"><figure class="highlight lsl"><table><tr><td class="code"><pre><span class="line">本文<span class="number">2015</span>年写的关于堡垒机文章的汇总。</span><br></pre></td></tr></table></figure>
<h2 id="堡垒机方案选型"><a href="#堡垒机方案选型" class="headerlink" title="堡垒机方案选型"></a>堡垒机方案选型</h2><h3 id="原始需求"><a href="#原始需求" class="headerlink" title="原始需求"></a>原始需求</h3><blockquote>
<ul>
<li>用户通过跳板机，访问目标服务器；</li>
<li>用户在跳板机上的行为和权限受限；</li>
<li>用户在目标服务器上的行为和权限受限；</li>
<li>用户在目标服务器上的操作被记录，方便后续回溯；</li>
</ul>
</blockquote>
<h3 id="选型思路"><a href="#选型思路" class="headerlink" title="选型思路"></a>选型思路</h3><h4 id="用户入口"><a href="#用户入口" class="headerlink" title="用户入口"></a>用户入口</h4><p>WebShell或传统SSH客户端？</p>
<p>WebShell解决方案——<a href="https://github.com/liftoff/GateOne" target="_blank" rel="noopener">gateone</a>。</p>
<p>在服务器上安装WebShell，用户登录后，访问相应账户。</p>
<p>优点</p>
<blockquote>
<ul>
<li>安装方便；</li>
<li>HTML5实现，无需安装插件，支持主流浏览器；</li>
<li>支持日志回放；</li>
</ul>
</blockquote>
<p>缺点</p>
<blockquote>
<ul>
<li>浏览器访问WebShell体验不好，快捷键失灵，容易误操作，效率低下</li>
<li>日志回放采用录屏的方式，不方便做二次处理</li>
</ul>
</blockquote>
<p>总结</p>
<p>实现基本功能，要进一步使用，需要做二次开发。</p>
<p>综合体验不佳，排除WebShell方案，还是采用传统ssh客户端方式。</p>
<h4 id="用户权限"><a href="#用户权限" class="headerlink" title="用户权限"></a>用户权限</h4><p>用户权限如何限制？</p>
<p>用户访问跳板机，使用普通账户，仅具备只读权限？存在严重的安全问题。</p>
<blockquote>
<ul>
<li>用户可绕过跳板机；</li>
<li>系统的实现代码，可能会泄露；</li>
<li>用户操作日志，可能会人为删除；</li>
</ul>
</blockquote>
<p>用户访问跳板机，使用普通账户，用户被封闭在jail环境中？符合要求。</p>
<blockquote>
<ul>
<li>仅具备基础的bash环境；</li>
<li>仅能执行管理员许可的命令；</li>
<li>运行环境可支持灵活配置；</li>
</ul>
</blockquote>
<p>跳板机访问目标服务器，使用普通账户，仅具备只读权限？符合要求。</p>
<blockquote>
<ul>
<li>目标服务器不宜做大规模配置变更；</li>
<li>用户需要具备大部分文件的只读权限；</li>
</ul>
</blockquote>
<p>综合：用户访问跳板机，权限高度受限，通过跳板机访问目标服务器，使用普通账户权限。</p>
<h4 id="登录目标服务器"><a href="#登录目标服务器" class="headerlink" title="登录目标服务器"></a>登录目标服务器</h4><p>跳板机登录目标服务器方案？</p>
<p>采用密码鉴权的方式？不符合要求。</p>
<blockquote>
<ul>
<li>密码需要配置在登录脚本中，拥有脚本执行权限的用户，可获得密码，绕过跳板机；</li>
<li>密码鉴权采用自动化脚本登录，有两种方式，expect、sshpas；<br>这两种方式，均依赖于pty(虚拟终端)，在jail环境中，无法支持pty。</li>
</ul>
</blockquote>
<p>不使用密码鉴权的方式？符合要求。</p>
<blockquote>
<ul>
<li>没有透明密码，采用密钥鉴权方式，仅在跳板机上生效；</li>
<li>不依赖pty，支持jail环境；<br>综合：不使用密码鉴权，采用密钥方式鉴权</li>
</ul>
</blockquote>
<h4 id="用户行为记录"><a href="#用户行为记录" class="headerlink" title="用户行为记录"></a>用户行为记录</h4><p>用户行为记录：tee或script？</p>
<p>tee可将标准输出写入到文件中，没有时间轴，直接读取文本回放。</p>
<p>script类似于录屏软件，记录时间轴和用户信息，采用scriptreplay命令回放。</p>
<p>考虑到记录回溯，采用纯文本的方式回溯，方便工具二次处理，选择tee。</p>
<p>还有其他选择？</p>
<p>解析history文件，没有时间轴，只有输入，没有输出，放弃。</p>
<p>《python自动化运维》中提到一种方案，在所有目标服务器上部署客户端，监控用户行为，主动向服务端上报，</p>
<p>此方案实现较为复杂，同时对现网架构改动较大，放弃。</p>
<h4 id="底层逻辑"><a href="#底层逻辑" class="headerlink" title="底层逻辑"></a>底层逻辑</h4><p>底层逻辑实现方式：shell或python？</p>
<p>Linux原生支持shell和python两种语言，其中shell更为基础。</p>
<p>采用shell语言？不符合要求。</p>
<blockquote>
<ul>
<li>代码实现效率低下；</li>
<li>代码可读性略差；</li>
<li>变量类型不够丰富；</li>
<li>基础类库无法扩展；</li>
</ul>
</blockquote>
<p>采用python语言？符合要求。</p>
<blockquote>
<ul>
<li>编程效率更好；</li>
<li>代码可读性更换；</li>
<li>变量类型丰富；</li>
<li>支持类库扩展；</li>
</ul>
</blockquote>
<p>综合：底层部分功能若Linux已经实现，直接调用，大部分的业务逻辑代码，使用python。</p>
<h2 id="使用jailkit搭建权限受限账户"><a href="#使用jailkit搭建权限受限账户" class="headerlink" title="使用jailkit搭建权限受限账户"></a>使用jailkit搭建权限受限账户</h2><p>操作系统版本：CentOS 6.5</p>
<p>jailkit版本：2.17</p>
<h3 id="设计需求"><a href="#设计需求" class="headerlink" title="设计需求"></a>设计需求</h3><p>搭建账户受限账户，用户访问目录受限，可执行命令受限</p>
<h3 id="安装过程"><a href="#安装过程" class="headerlink" title="安装过程"></a>安装过程</h3><p>安装jailkit</p>
<figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">从官网 http:<span class="comment">//olivier.sessink.nl/jailkit/ 下载安装包</span></span><br><span class="line">tar -zxvf jailkit-<span class="number">2.17</span><span class="selector-class">.tar</span><span class="selector-class">.gz</span></span><br><span class="line">cd jailkit-<span class="number">2.17</span></span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<h3 id="配置jail"><a href="#配置jail" class="headerlink" title="配置jail"></a>配置jail</h3><p>使用root账户，新建目录/opt/jail</p>
<p>初始化jial目录，安装lsh环境</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">jk_init</span> -v -j /<span class="meta">opt</span>/jail/ jk_lsh</span><br></pre></td></tr></table></figure>
<p>安装ssh环境</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">jk_init</span> -v -j /<span class="meta">opt</span>/jail/ ssh</span><br></pre></td></tr></table></figure>
<p>安装python</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">jk_init -v -<span class="keyword">j</span> /<span class="keyword">opt</span>/jail/ <span class="keyword">python</span></span><br></pre></td></tr></table></figure>
<p>默认配置中没有python的初始化配置，检查系统中python目录，增加配置</p>
<figure class="highlight elixir"><table><tr><td class="code"><pre><span class="line">vim /etc/jailkit/jk_init.ini</span><br><span class="line"></span><br><span class="line">comment = the python interpreter <span class="keyword">and</span> libraries</span><br><span class="line">paths = <span class="regexp">/usr/bin</span><span class="regexp">/python, /usr</span><span class="regexp">/bin/python</span>2.<span class="number">6</span>, <span class="regexp">/usr/lib</span><span class="regexp">/python2.6, /usr</span><span class="regexp">/lib64/python</span>2.<span class="number">6</span>, <span class="regexp">/usr/include</span><span class="regexp">/python2.6</span></span><br></pre></td></tr></table></figure>
<h3 id="新建用户"><a href="#新建用户" class="headerlink" title="新建用户"></a>新建用户</h3><figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line"><span class="symbol">useradd</span> ktvworker</span><br><span class="line">修改密码</span><br><span class="line"><span class="symbol">passwd</span> ktvworker</span><br><span class="line">切换用户，生成密钥对</span><br><span class="line"><span class="symbol">su</span> ktvworker</span><br><span class="line"><span class="symbol">ssh</span>-keygen -t rsa</span><br><span class="line">将用户迁移至jail环境</span><br><span class="line"><span class="symbol">jk_jailuser</span> -m -v -j /<span class="meta">opt</span>/jail/ ktvworker</span><br></pre></td></tr></table></figure>
<h3 id="配置bash环境"><a href="#配置bash环境" class="headerlink" title="配置bash环境"></a>配置bash环境</h3><figure class="highlight dts"><table><tr><td class="code"><pre><span class="line">为实现跳板机用户远程访问</span><br><span class="line">jk_cp -v -j <span class="meta-keyword">/opt/</span>jail/ <span class="meta-keyword">/bin/</span>bash</span><br><span class="line">修改jail环境中passwd配置</span><br><span class="line">vim <span class="meta-keyword">/opt/</span>jail<span class="meta-keyword">/etc/</span>passwd</span><br><span class="line">将用户的shell程序由<span class="meta-keyword">/usr/</span>sbin/jk_lsh修改为<span class="meta-keyword">/bin/</span>bash</span><br></pre></td></tr></table></figure>
<h3 id="配置完成"><a href="#配置完成" class="headerlink" title="配置完成"></a>配置完成</h3><p>现已经得到一个仅支持基础bash命令，同时支持python环境的jail环境。</p>
<h3 id="特别说明"><a href="#特别说明" class="headerlink" title="特别说明"></a>特别说明</h3><p>jk_init用于读取配置文件，初始化jail运行环境。</p>
<p>jk_cp用户复制当个文件，会自动关联系统库文件。</p>
<p>为避免跳板机被占用，设置空闲10分钟自动退出</p>
<figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"><span class="attribute">TMOUT</span>=600</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="使用jailkit搭建运维跳板机"><a href="#使用jailkit搭建运维跳板机" class="headerlink" title="使用jailkit搭建运维跳板机"></a>使用jailkit搭建运维跳板机</h2><h3 id="设计需求-1"><a href="#设计需求-1" class="headerlink" title="设计需求"></a>设计需求</h3><p>用户通过访问权限受限跳板机，采用免鉴权的方式，访问目标服务器，操作日志可追踪。</p>
<h3 id="设置"><a href="#设置" class="headerlink" title="设置"></a>设置</h3><p>前提是jail环境已经配置完成。</p>
<h4 id="跳板机相关配置"><a href="#跳板机相关配置" class="headerlink" title="跳板机相关配置"></a>跳板机相关配置</h4><p>使用tee跟踪操作日志，复制tee文件至jail环境。</p>
<figure class="highlight awk"><table><tr><td class="code"><pre><span class="line">jk_cp -v -j <span class="regexp">/opt/</span>jail<span class="regexp">/ /u</span>sr<span class="regexp">/bin/</span>tee</span><br></pre></td></tr></table></figure>
<p>在ktv家目录新建serverlist文件，维护服务器名称和IP地址对应关系。</p>
<p>新建init文件，向用户提示使用方法，修改ktv的.bashrc文件，增加.init。</p>
<p>里面saltstack批量删除服务器上密钥。</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">salt -N <span class="string">'ktv'</span> <span class="keyword">cmd</span>.<span class="bash">run <span class="string">"rm -rf /home/ktvworker/.ssh/authorized_keys"</span></span></span><br></pre></td></tr></table></figure>
<p>利用python脚本调用ssh-copy-id命令，向目标服务器分发key文件。</p>
<h4 id="ssh命令替换"><a href="#ssh命令替换" class="headerlink" title="ssh命令替换"></a>ssh命令替换</h4><p>将系统的ssh命令更名，将更名后的ssh文件配置在python脚本中。</p>
<p>在使用新建名为ssh的shell脚本，放在环境变量指定的目录。</p>
<p>实现用户仅能访问指定的ssh命令，同时行为受到约束。</p>
<p>参考<a href="http://olivier.sessink.nl/jailkit/howtos_ssh_only.html" target="_blank" rel="noopener">官网资料</a></p>
</div><div class="tags"><a href="/tags/堡垒机/">堡垒机</a></div><div class="post-nav"><a class="next" href="/2018/11/06/CentOS限制sftp用户访问目录/">CentOS限制sftp用户访问目录</a></div><div id="container"></div><link rel="stylesheet" type="text/css" href="//unpkg.com/gitalk/dist/gitalk.css?v=0.0.3"><script type="text/javascript" src="//cdn.bootcss.com/blueimp-md5/2.10.0/js/md5.js?v=0.0.3"></script><script type="text/javascript" src="//unpkg.com/gitalk/dist/gitalk.min.js?v=0.0.3"></script><script>var gitalk = new Gitalk({
  clientID: '006e5f00ed97113fdd82',
  clientSecret: 'cf1e215058deb82e58b4bca24cc79b7011427033',
  repo: 'gitment-comments',
  owner: 'zhuwanjun2008',
  admin: ['zhuwanjun2008'],
  id: md5(location.pathname),
  distractionFreeMode: false
})
gitalk.render('container')
</script></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/PPTP/" style="font-size: 15px;">PPTP</a> <a href="/tags/CentOS/" style="font-size: 15px;">CentOS</a> <a href="/tags/Haproxy/" style="font-size: 15px;">Haproxy</a> <a href="/tags/Gitoite/" style="font-size: 15px;">Gitoite</a> <a href="/tags/Mongodb/" style="font-size: 15px;">Mongodb</a> <a href="/tags/Keepalived/" style="font-size: 15px;">Keepalived</a> <a href="/tags/Nginx/" style="font-size: 15px;">Nginx</a> <a href="/tags/Rsync/" style="font-size: 15px;">Rsync</a> <a href="/tags/Hexo/" style="font-size: 15px;">Hexo</a> <a href="/tags/Outlook/" style="font-size: 15px;">Outlook</a> <a href="/tags/OpenResty/" style="font-size: 15px;">OpenResty</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/堡垒机/" style="font-size: 15px;">堡垒机</a> <a href="/tags/阿里云/" style="font-size: 15px;">阿里云</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2018/11/07/运维堡垒机文章汇总/">运维堡垒机文章汇总</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/CentOS限制sftp用户访问目录/">CentOS限制sftp用户访问目录</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/阿里云OSS使用记录/">阿里云OSS使用记录</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/CentOS安装Mysql双主/">CentOS安装Mysql双主</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/CentOS安装OpenVPN/">CentOS安装OpenVPN</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/CentOS安装Gitoite双机/">CentOS安装Gitoite双机</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/工作中的小技巧/">工作中的小技巧</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/CentOS安装Keepalived/">CentOS安装Keepalived</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/06/CentOS连接PPTP服务端/">CentOS连接PPTP服务端</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/11/02/CentOS安装Mongodb副本集/">CentOS安装Mongodb副本集</a></li></ul></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2018 <a href="/." rel="nofollow">万骏的博客.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=0.0.3" async></script><script type="text/javascript" src="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=0.0.3" async></script><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/3.3.5/jquery.fancybox.min.css"><script type="text/javascript" src="/js/search.js?v=0.0.3"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.3"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.3"></script></div></body></html>