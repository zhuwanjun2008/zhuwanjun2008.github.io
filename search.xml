<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title>CentOS7升级系统和内核版本</title>
      <link href="/2018/10/31/CentOS7%E5%8D%87%E7%BA%A7%E7%B3%BB%E7%BB%9F%E5%92%8C%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC/"/>
      <url>/2018/10/31/CentOS7%E5%8D%87%E7%BA%A7%E7%B3%BB%E7%BB%9F%E5%92%8C%E5%86%85%E6%A0%B8%E7%89%88%E6%9C%AC/</url>
      
        <content type="html"><![CDATA[<p>为安装新版本 Kubernetes，升级公有云 CentOS 的系统和内核版本。</p><h2 id="检查系统和内核版本"><a href="#检查系统和内核版本" class="headerlink" title="检查系统和内核版本"></a>检查系统和内核版本</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/redhat-release</span><br><span class="line">CentOS Linux release <span class="number">7.4</span><span class="number">.1708</span> (Core)</span><br><span class="line"></span><br><span class="line"># uname -sr</span><br><span class="line">Linux <span class="number">3.10</span><span class="number">.0</span><span class="number">-693.17</span><span class="number">.1</span>.el7.x86_64</span><br></pre></td></tr></table></figure><h2 id="更新系统"><a href="#更新系统" class="headerlink" title="更新系统"></a>更新系统</h2><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># yum update</span></span><br></pre></td></tr></table></figure><p>更新成功后，重启系统</p><h2 id="检查系统和内核版本-1"><a href="#检查系统和内核版本-1" class="headerlink" title="检查系统和内核版本"></a>检查系统和内核版本</h2><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># cat /etc/redhat-release</span><br><span class="line">CentOS Linux release <span class="number">7.5</span><span class="number">.1804</span> (Core)</span><br><span class="line"></span><br><span class="line"># uname -sr</span><br><span class="line">Linux <span class="number">3.10</span><span class="number">.0</span><span class="number">-693.17</span><span class="number">.1</span>.el7.x86_64</span><br></pre></td></tr></table></figure><p>系统版本已经升级到最新，内核版本未升级。</p><h2 id="更新内核"><a href="#更新内核" class="headerlink" title="更新内核"></a>更新内核</h2><p>安装 ELRepo 库</p><figure class="highlight clean"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># rpm --<span class="keyword">import</span> https:<span class="comment">//www.elrepo.org/RPM-GPG-KEY-elrepo.org</span></span><br><span class="line"># rpm -Uvh http:<span class="comment">//www.elrepo.org/elrepo-release-7.0-2.el7.elrepo.noarch.rpm</span></span><br></pre></td></tr></table></figure><p>安装最新发行版</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> yum --disablerepo=<span class="string">"*"</span> --enablerepo=<span class="string">"elrepo-kernel"</span> list available</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> yum --enablerepo=elrepo-kernel install kernel<span class="_">-lt</span></span></span><br></pre></td></tr></table></figure><p>设置更新后的默认内核</p><figure class="highlight vala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># grub2-set-default 0</span></span><br><span class="line"><span class="meta"># grub2-editenv list</span></span><br></pre></td></tr></table></figure><p>重启服务器，检查版本号</p><figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># <span class="selector-tag">uname</span> <span class="selector-tag">-sr</span></span><br><span class="line"><span class="selector-tag">Linux</span> 4<span class="selector-class">.4</span><span class="selector-class">.161-1</span><span class="selector-class">.el7</span><span class="selector-class">.elrepo</span><span class="selector-class">.x86_64</span></span><br></pre></td></tr></table></figure><p>删除旧版本(可选)</p><figure class="highlight lsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># rpm -qa | grep kernel</span><br><span class="line"># yum remove abrt-addon-kerneloops<span class="number">-2.1</span><span class="number">.11</span><span class="number">-48.</span>el7.centos.x86_64 kernel-tools<span class="number">-3.10</span><span class="number">.0</span><span class="number">-693.</span>el7.x86_64 kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-693.17</span><span class="number">.1</span>.el7.x86_64 kernel<span class="number">-3.10</span><span class="number">.0</span><span class="number">-693.</span>el7.x86_64 kernel-tools-libs<span class="number">-3.10</span><span class="number">.0</span><span class="number">-693.</span>el7.x86_64</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> CentOS </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>OpenResty运行Lua示例</title>
      <link href="/2018/10/30/OpenResty%E8%BF%90%E8%A1%8CLua%E7%A4%BA%E4%BE%8B/"/>
      <url>/2018/10/30/OpenResty%E8%BF%90%E8%A1%8CLua%E7%A4%BA%E4%BE%8B/</url>
      
        <content type="html"><![CDATA[<p>OpenResty 是一个基于 Nginx 与 Lua 的高性能 Web 平台。</p><p>更多信息，参考 <a href="http://openresty.org/" target="_blank" rel="noopener">OpenResty 官网</a>。</p><p>安装过程跟 Nginx 基本相同，区别在于安装完成之后，默认安装了很多 Module。</p><p>安装完成后，执行 ./nginx -V 的结果</p><figure class="highlight oxygene"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nginx version: openresty/<span class="number">1.13</span>.<span class="number">6.2</span></span><br><span class="line">built <span class="keyword">by</span> gcc <span class="number">4.8</span>.<span class="number">5</span> <span class="number">20150623</span> (Red Hat <span class="number">4.8</span>.<span class="number">5</span>-<span class="number">28</span>) (GCC) </span><br><span class="line">built <span class="keyword">with</span> OpenSSL <span class="number">1.0</span>.<span class="number">2</span>k-fips  <span class="number">26</span> Jan <span class="number">2017</span></span><br><span class="line">TLS SNI support enabled</span><br><span class="line">configure arguments: --prefix=/work/admin/openresty/nginx --<span class="keyword">with</span>-cc-opt=-O2 --<span class="keyword">add</span>-<span class="keyword">module</span>=../ngx_devel_kit-<span class="number">0.3</span>.<span class="number">0</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../echo-nginx-<span class="keyword">module</span>-<span class="number">0.61</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../xss-nginx-<span class="keyword">module</span>-<span class="number">0.06</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../ngx_coolkit-<span class="number">0.2</span>rc3 --<span class="keyword">add</span>-<span class="keyword">module</span>=../<span class="keyword">set</span>-misc-nginx-<span class="keyword">module</span>-<span class="number">0.32</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../form-input-nginx-<span class="keyword">module</span>-<span class="number">0.12</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../encrypted-session-nginx-<span class="keyword">module</span>-<span class="number">0.08</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../srcache-nginx-<span class="keyword">module</span>-<span class="number">0.31</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../ngx_lua-<span class="number">0.10</span>.<span class="number">13</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../ngx_lua_upstream-<span class="number">0.07</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../headers-more-nginx-<span class="keyword">module</span>-<span class="number">0.33</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../<span class="keyword">array</span>-<span class="keyword">var</span>-nginx-<span class="keyword">module</span>-<span class="number">0.05</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../memc-nginx-<span class="keyword">module</span>-<span class="number">0.19</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../redis2-nginx-<span class="keyword">module</span>-<span class="number">0.15</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../redis-nginx-<span class="keyword">module</span>-<span class="number">0.3</span>.<span class="number">7</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../rds-json-nginx-<span class="keyword">module</span>-<span class="number">0.15</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../rds-csv-nginx-<span class="keyword">module</span>-<span class="number">0.09</span> --<span class="keyword">add</span>-<span class="keyword">module</span>=../ngx_stream_lua-<span class="number">0.0</span>.<span class="number">5</span> --<span class="keyword">with</span>-ld-opt=-Wl,-rpath,/work/admin/openresty/luajit/lib --<span class="keyword">with</span>-stream --<span class="keyword">with</span>-stream_ssl_module --<span class="keyword">with</span>-http_ssl_module</span><br></pre></td></tr></table></figure><p>OpenResty 配置文件格式同 Nginx 完全兼容，区别在于可在各个处理阶段中，嵌入 Lua 代码。</p><p>下面是一个示例，在 rewrite 阶段，读取 Post 包请求体中的 JSON 字段，将请求重定向到不同的后端服务上去。</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/myweb.log  access;</span></span><br><span class="line">    <span class="attribute">access_log</span>  <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$backend</span> <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">        <span class="section">rewrite_by_lua_block</span> &#123;</span><br><span class="line"></span><br><span class="line">            <span class="attribute">local</span> json = require(<span class="string">"cjson.safe"</span>)</span><br><span class="line"></span><br><span class="line">            ngx.req.read_body()</span><br><span class="line"></span><br><span class="line">            local body_data = ngx.req.get_body_data()</span><br><span class="line">            local body_data_json = json.decode(body_data)</span><br><span class="line"></span><br><span class="line">            if string.find(body_data_json[<span class="string">"key"</span>],<span class="string">"value"</span>) then</span><br><span class="line">                back = <span class="string">"127.0.0.1:10000"</span></span><br><span class="line">            else</span><br><span class="line">                back = <span class="string">"myweb"</span></span><br><span class="line">            end</span><br><span class="line"></span><br><span class="line">            ngx.var.backend = back</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        proxy_pass http://<span class="variable">$backend</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_set_header</span> Host <span class="variable">$host</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X_Real_IP <span class="variable">$remote_addr</span>;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> X_Forwarded_For <span class="variable">$proxy_add_x_forwarded_for</span>;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> timeout invalid_header http_404 http_500 http_502 http_503;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> OpenResty </tag>
            
        </tags>
      
    </entry>
    
    <entry>
      <title>新的开始</title>
      <link href="/2018/10/30/%E6%96%B0%E7%9A%84%E5%BC%80%E5%A7%8B/"/>
      <url>/2018/10/30/%E6%96%B0%E7%9A%84%E5%BC%80%E5%A7%8B/</url>
      
        <content type="html"><![CDATA[<p>从今天开始，博客从 WordPress 切换为 Hexo。</p><p>后面有两件事情：</p><p>1.原有博客中的部分文章，迁移到新的博客中来。</p><p>2.近期的工作积累，沉淀为技术文章，计划为每周一篇。</p>]]></content>
      
      
      
    </entry>
    
  
  
</search>
